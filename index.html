<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>فرم اطلاعات پرسنلی</title>
  <!-- Bootstrap RTL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Persian datepicker CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <!-- Vazirmatn Font -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <style>
    body { 
      font-family: Vazirmatn, Tahoma, sans-serif; 
      color: #1f2937; 
    }
    .card-header { font-weight: 600; }
    .form-label { font-size: 0.92rem; }
    .form-control, .form-select, textarea { padding: 0.55rem 0.75rem; }
    pre { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 14px; direction: ltr; }
    #toastArea { z-index: 1080; }
    @media print {
      .btn, #resultCard, .card:first-of-type { display: none !important; }
      @page { size: A4; margin: 18mm; }
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h2 class="mb-3 text-primary">فرم اطلاعات پرسنلی</h2>
    <p class="text-muted mb-4">ثبت، ویرایش، حذف و جستجوی اطلاعات با تاریخ شمسی</p>

    <!-- جستجو -->
    <div class="card mb-3">
      <div class="card-body d-flex gap-2 align-items-center">
        <input type="text" id="searchLastName" class="form-control" placeholder="جستجو بر اساس نام خانوادگی">
        <button type="button" id="searchBtn" class="btn btn-primary">جستجو</button>
        <span class="ms-auto text-muted small" id="recordIndicator">–</span>
      </div>
    </div>

    <form id="personnelForm" class="needs-validation" novalidate>
      <!-- مشخصات هویتی -->
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">مشخصات هویتی</div>
        <div class="card-body row g-3">
          <div class="col-md-4">
            <label class="form-label">نام</label>
            <input type="text" class="form-control" name="firstName" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">نام خانوادگی</label>
            <input type="text" class="form-control" name="lastName" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">کد پرسنلی</label>
            <input type="text" class="form-control" name="personnelCode" pattern="^[0-9]{5,12}$">
          </div>

          <div class="col-md-4">
            <label class="form-label">جنسیت</label>
            <select class="form-select" name="gender">
              <option value="">انتخاب کنید</option>
              <option>مرد</option>
              <option>زن</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">نام پدر</label>
            <input type="text" class="form-control" name="fatherName">
          </div>

          <div class="col-md-4">
            <label class="form-label">کد ملی</label>
            <input type="text" class="form-control" name="nationalId" pattern="^[0-9]{10}$">
          </div>

          <div class="col-md-6">
            <label class="form-label">محل صدور</label>
            <input type="text" class="form-control" name="issuePlace">
          </div>

          <div class="col-md-6">
            <label class="form-label">محل تولد</label>
            <input type="text" class="form-control" name="birthPlace">
          </div>

          <!-- تاریخ تولد (شمسی) -->
          <div class="col-md-6">
            <label class="form-label">تاریخ تولد (شمسی)</label>
            <input type="text" class="form-control" id="birthDateJalali" placeholder="مثلاً 1404/08/20">
            <input type="hidden" name="birthDate">
          </div>

          <!-- وضعیت تأهل -->
          <div class="col-md-6">
            <label class="form-label">وضعیت تأهل</label>
            <select class="form-select" name="maritalStatus">
              <option value="">انتخاب کنید</option>
              <option>مجرد</option>
              <option>متأهل</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">تعداد فرزندان</label>
            <input type="number" class="form-control" name="childrenCount" min="0" step="1">
          </div>
        </div>
      </div>

      <!-- مشخصات شغلی -->
      <div class="card border-success mb-3">
        <div class="card-header bg-success text-white">مشخصات شغلی</div>
        <div class="card-body row g-3">
          <div class="col-md-4">
            <label class="form-label">سمت</label>
            <select class="form-select" name="position" required>
              <option value="">انتخاب کنید</option>
              <option>مدیر</option>
              <option>آموزگار</option>
              <option>معاون آموزشی</option>
              <option>معاون پرورشی</option>
              <option>معاون اجرایی</option>
              <option>مربی پرورشی</option>
              <option>مربی ورزشی</option>
              <option>مربی بهداشت</option>
              <option>خدمتگذار</option>
              <option>سرایدار</option>
              <option>سایر</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">نوع استخدام</label>
            <select class="form-select" name="employmentType" required>
              <option value="">انتخاب کنید</option>
              <option>رسمی</option>
              <option>رسمی آزمایشی</option>
              <option>پیمانی</option>
              <option>قراردادی</option>
              <option>سایر</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">نوع اشتغال</label>
            <select class="form-select" name="dutyType" required>
              <option value="">انتخاب کنید</option>
              <option>موظف</option>
              <option>غیر موظف</option>
              <option>سایر</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">مدرک تحصیلی</label>
            <select class="form-select" name="degree" required>
              <option value="">انتخاب کنید</option>
              <option>ابتدایی</option>
              <option>سیکل</option>
              <option>دیپلم</option>
              <option>فوق دیپلم</option>
              <option>لیسانس</option>
              <option>فوق لیسانس</option>
              <option>دکترا</option>
              <option>سایر</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">رشته تحصیلی</label>
            <input type="text" class="form-control" name="major">
          </div>

          <div class="col-md-4">
            <label class="form-label">سابقه (سال)</label>
            <input type="number" class="form-control" name="experienceYears" min="0" step="1">
          </div>

          <!-- پایه -->
          <div class="col-md-4">
            <label class="form-label">پایه</label>
            <select class="form-select" name="grade">
              <option value="">انتخاب کنید</option>
              <option>اول</option>
              <option>دوم</option>
              <option>سوم</option>
              <option>چهارم</option>
              <option>پنجم</option>
              <option>ششم</option>
            </select>
          </div>

          <!-- شماره کلاس 1 تا 6 -->
          <div class="col-md-4">
            <label class="form-label">شماره کلاس</label>
            <select class="form-select" name="classNumber">
              <option value="">انتخاب کنید</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">رابط</label>
            <input type="text" class="form-control" name="liaison">
          </div>

          <div class="col-md-6">
            <label class="form-label">شماره حساب حقوقی</label>
            <input type="text" class="form-control" name="salaryAccount">
          </div>

          <div class="col-md-6">
            <label class="form-label">نوع بیمه</label>
            <select class="form-select" name="insuranceType">
              <option value="">انتخاب کنید</option>
              <option>تأمین اجتماعی</option>
              <option>خدمات درمانی</option>
              <option>بیمه سلامت</option>
              <option>سایر</option>
            </select>
          </div>
        </div>
      </div>

      <!-- اطلاعات تماس و نشانی -->
      <div class="card border-warning mb-3">
        <div class="card-header bg-warning">اطلاعات تماس و نشانی</div>
        <div class="card-body row g-3">
          <div class="col-md-4">
            <label class="form-label">شماره همراه</label>
            <input type="tel" class="form-control" name="mobile" inputmode="numeric" pattern="^0?9[0-9]{9}$">
          </div>
          <div class="col-md-4">
            <label class="form-label">شماره تلفن ثابت</label>
            <input type="tel" class="form-control" name="phone" inputmode="numeric" pattern="^0[0-9]{9,10}$">
          </div>
          <div class="col-md-4">
            <label class="form-label">کد پستی</label>
            <input type="text" class="form-control" name="postalCode" inputmode="numeric" pattern="^[0-9]{10}$">
          </div>
          <div class="col-md-12">
            <label class="form-label">آدرس محل سکونت</label>
            <textarea class="form-control" name="address" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">نام و نام خانوادگی همسر</label>
            <input type="text" class="form-control" name="spouseName">
          </div>
          <div class="col-md-6">
            <label class="form-label">شغل همسر</label>
            <input type="text" class="form-control" name="spouseJob">
          </div>
        </div>
      </div>

      <!-- تایید و امضا -->
      <div class="card border-secondary mb-3">
        <div class="card-header bg-secondary text-white">تایید و امضا</div>
        <div class="card-body row g-3">
          <div class="col-md-6">
            <label class="form-label">نام تاییدکننده</label>
            <input type="text" class="form-control" name="approverName">
          </div>
          <div class="col-md-6">
            <label class="form-label">تاریخ تایید (شمسی)</label>
            <input type="text" class="form-control" id="approveDateJalali" placeholder="مثلاً 1404/08/20">
            <input type="hidden" name="approveDate">
          </div>
          <div class="col-12">
            <label class="form-label d-block">امضا</label>
            <div class="border border-2 rounded p-4 bg-light" style="min-height:100px" aria-label="محل امضا"></div>
          </div>
        </div>
      </div>

      <!-- دکمه‌ها -->
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-success">ثبت</button>
          <button type="button" id="updateBtn" class="btn btn-primary">ویرایش</button>
          <button type="button" id="deleteBtn" class="btn btn-danger">حذف</button>
        </div>
      </div>
    </form>

    <!-- خروجی و پیام‌ها -->
    <div id="resultCard" class="card mt-3 d-none">
      <div class="card-header">خروجی JSON</div>
      <div class="card-body">
        <pre id="resultJson"></pre>
      </div>
    </div>

    <div id="toastArea" class="position-fixed bottom-0 end-0 p-3"></div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>

  <!-- اسکریپت داخلی -->
  <script>
    // آدرس وب‌اپ شما
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw-0jmQkBlerrFp3xq7xr3KyqlrEW8t5g3gUZKQjfXZG8U_-eva9t4JZDy4Ioozxn1mfA/exec";

    const form = document.getElementById('personnelForm');
    const resultCard = document.getElementById('resultCard');
    const resultJson = document.getElementById('resultJson');
    const updateBtn = document.getElementById('updateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const searchBtn = document.getElementById('searchBtn');
    const searchLastName = document.getElementById('searchLastName');
    const recordIndicator = document.getElementById('recordIndicator');

    let staffData = [];
    let currentIndex = -1;

    // راه‌اندازی تاریخ شمسی
    new persianDate().toLocale('fa');
    $('#birthDateJalali').persianDatepicker({
      format: 'YYYY/MM/DD',
      initialValue: false,
      autoClose: true,
      onSelect: function(unix) {
        const date = new persianDate(unix).format('YYYY/MM/DD');
        document.querySelector('input[name="birthDate"]').value = date;
      }
    });
    $('#approveDateJalali').persianDatepicker({
      format: 'YYYY/MM/DD',
      initialValue: false,
      autoClose: true,
      onSelect: function(unix) {
        const date = new persianDate(unix).format('YYYY/MM/DD');
        document.querySelector('input[name="approveDate"]').value = date;
      }
    });

    // نمایش Toast
    function showToast(message, variant = 'info') {
      const id = 't' + Date.now();
      const html = `
        <div id="${id}" class="toast align-items-center text-bg-${variant} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>`;
      document.getElementById('toastArea').insertAdjacentHTML('beforeend', html);
      new bootstrap.Toast(document.getElementById(id), { delay: 2500 }).show();
    }

    // جمع‌آوری داده‌های فرم
    function collectFormData() {
      const data = {};
      const formData = new FormData(form);
      formData.forEach(function(v, k) {
        data[k] = (typeof v === 'string') ? v.trim() : v;
      });
      return data;
    }

    // پر کردن فرم از رکورد
    function fillForm(row) {
      Object.entries(row).forEach(function([k, v]) {
        const el = form.elements.namedItem(k);
        if (el) el.value = v || '';
      });
      if (row.birthDate) {
        document.getElementById('birthDateJalali').value = row.birthDate;
      }
      if (row.approveDate) {
        document.getElementById('approveDateJalali').value = row.approveDate;
      }
    }

    // اندیکاتور رکورد
    function updateIndicator() {
      recordIndicator.textContent = (currentIndex >= 0 && staffData.length) ? (currentIndex + 1) + ' از ' + staffData.length : '–';
    }

    // بارگذاری همه - استفاده از JSONP
    function loadAll(silent = false) {
      try {
        const url = WEBAPP_URL + '?action=getAll&callback=handleLoadData';
        const script = document.createElement('script');
        script.src = url;
        
        window.handleLoadData = function(data) {
          staffData = Array.isArray(data) ? data : [];
          currentIndex = staffData.length ? 0 : -1;
          if (currentIndex >= 0) {
            fillForm(staffData[currentIndex]);
          }
          updateIndicator();
          if (!silent) showToast('داده‌ها بارگذاری شد.', 'info');
          document.head.removeChild(script);
          delete window.handleLoadData;
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error loading data:', error);
        if (!silent) showToast('بارگذاری داده‌ها ناموفق بود.', 'danger');
      }
    }

    // بارگذاری اولیه
    setTimeout(function() {
      loadAll(true);
    }, 1000);

    // ثبت - استفاده از JSONP
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const data = collectFormData();
      try {
        // جمع‌آوری پارامترها
        const params = new URLSearchParams();
        params.append('action', 'create');
        params.append('callback', 'handleCreate');
        Object.entries(data).forEach(([k, v]) => {
          params.append(k, v);
        });
        
        const url = WEBAPP_URL + '?' + params.toString();
        const script = document.createElement('script');
        script.src = url;
        script.onerror = function() {
          showToast('خطا در ارسال اطلاعات.', 'danger');
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
        };
        
        window.handleCreate = function(json) {
          console.log('Response:', json);
          resultJson.textContent = JSON.stringify(json, null, 2);
          resultCard.classList.remove('d-none');
          if (json.status === 'success') {
            showToast('اطلاعات با موفقیت ثبت شد.', 'success');
            form.reset();
            setTimeout(() => loadAll(true), 500);
          } else {
            showToast('خطا در ثبت: ' + json.message, 'danger');
          }
          document.head.removeChild(script);
          delete window.handleCreate;
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error submitting form:', error);
        showToast('ثبت با خطا مواجه شد: ' + error.message, 'danger');
      }
    });

    // ویرایش
    updateBtn.addEventListener('click', function() {
      const data = collectFormData();
      const key = data.personnelCode || data.nationalId;
      if (!key) {
        showToast('برای ویرایش، کد پرسنلی یا کد ملی لازم است.', 'warning');
        return;
      }
      try {
        const params = new URLSearchParams();
        params.append('action', 'update');
        params.append('key', key);
        params.append('callback', 'handleUpdate');
        Object.entries(data).forEach(([k, v]) => params.append(k, v));
        
        const url = WEBAPP_URL + '?' + params.toString();
        const script = document.createElement('script');
        script.src = url;
        script.onerror = function() {
          showToast('خطا در ویرایش.', 'danger');
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
        };
        
        window.handleUpdate = function(json) {
          console.log('Response:', json);
          resultJson.textContent = JSON.stringify(json, null, 2);
          resultCard.classList.remove('d-none');
          if (json.status === 'success') {
            showToast('ویرایش با موفقیت انجام شد.', 'primary');
            setTimeout(() => loadAll(true), 500);
          } else {
            showToast('خطا در ویرایش: ' + json.message, 'danger');
          }
          document.head.removeChild(script);
          delete window.handleUpdate;
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error updating:', error);
        showToast('ویرایش با خطا مواجه شد: ' + error.message, 'danger');
      }
    });

    // حذف
    deleteBtn.addEventListener('click', function() {
      const data = collectFormData();
      const key = data.personnelCode || data.nationalId;
      if (!key) {
        showToast('برای حذف، کد پرسنلی یا کد ملی لازم است.', 'warning');
        return;
      }
      if (!confirm('آیا از حذف این رکورد مطمئن هستید؟')) return;
      try {
        const params = new URLSearchParams();
        params.append('action', 'delete');
        params.append('key', key);
        params.append('callback', 'handleDelete');
        
        const url = WEBAPP_URL + '?' + params.toString();
        const script = document.createElement('script');
        script.src = url;
        script.onerror = function() {
          showToast('خطا در حذف.', 'danger');
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
        };
        
        window.handleDelete = function(json) {
          console.log('Response:', json);
          resultJson.textContent = JSON.stringify(json, null, 2);
          resultCard.classList.remove('d-none');
          if (json.status === 'success') {
            showToast('رکورد با موفقیت حذف شد.', 'danger');
            form.reset();
            setTimeout(() => loadAll(true), 500);
          } else {
            showToast('خطا در حذف: ' + json.message, 'danger');
          }
          document.head.removeChild(script);
          delete window.handleDelete;
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error deleting:', error);
        showToast('حذف با خطا مواجه شد: ' + error.message, 'danger');
      }
    });

    // جستجو بر اساس نام خانوادگی
    searchBtn.addEventListener('click', function() {
      const q = (searchLastName.value || '').trim();
      if (!q) {
        showToast('نام خانوادگی را وارد کنید.', 'warning');
        return;
      }
      try {
        const url = WEBAPP_URL + '?action=getByLastName&lastName=' + encodeURIComponent(q) + '&callback=handleSearchData';
        const script = document.createElement('script');
        script.src = url;
        
        window.handleSearchData = function(list) {
          if (!Array.isArray(list) || list.length === 0) {
            showToast('همکار یافت نشد.', 'warning');
            return;
          }
          staffData = list;
          currentIndex = 0;
          fillForm(staffData[currentIndex]);
          updateIndicator();
          showToast('نتایج جستجو بارگذاری شد.', 'info');
          document.head.removeChild(script);
          delete window.handleSearchData;
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error searching:', error);
        showToast('جستجو با خطا مواجه شد.', 'danger');
      }
    });
  </script>
</body>
</html>